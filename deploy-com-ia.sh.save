#!/bin/bash

if [ $# -ne 2 ]; then echo "Uso: $0 <cluster-name> <service-name>" exit 
    1
fi

CLUSTER_NAME=$1
SERVICE_NAME=$2
REPOSITORY_URI="697767916882.dkr.ecr.us-east-1.amazonaws.com/bia"
COMMIT_HASH=$(git rev-parse --short=7 HEAD)

echo "Deploy BIA - Commit: $COMMIT_HASH"

aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 697767916882.dkr.ecr.us-east-1.amazonaws.com

docker build -t $REPOSITORY_URI:$COMMIT_HASH .
docker push $REPOSITORY_URI:$COMMIT_HASH

TASK_DEF_ARN=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query 'services[0].taskDefinition' --output text)
aws ecs describe-task-definition --task-definition $TASK_DEF_ARN --query 'taskDefinition' > task-def-temp.json

jq --arg uri "$REPOSITORY_URI:$COMMIT_HASH" '.containerDefinitions[0].image = $uri | del(.taskDefinitionArn, .revision, .status, .requiresAttributes, .placementConstraints, .compatibilities, .registeredAt, .registeredBy)' task-def-temp.json > task-def-new.json

NEW_TASK_DEF=$(aws ecs register-task-definition --cli-input-json file://task-def-new.json --query 'taskDefinition.taskDefinitionArn' --output text)
aws ecs update-service --cluster $CLUSTER_NAME --service $SERVICE_NAME --task-definition $NEW_TASK_DEF

echo "Deploy conclu√≠do: $REPOSITORY_URI:$COMMIT_HASH"
rm -f task-def-temp.json task-def-new.json
